<!-- app/templates/job_list.html -->
{% extends "base.html" %}

{% block content %}
<div>
    <h2>Jobs</h2>
    <a href="{{ url_for('main.index') }}" style="display: inline-block; padding: 10px; background: #2196F3; color: white; text-decoration: none; margin-bottom: 20px;">Back to Customers</a>
    
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background: #f5f5f5;">
                <th style="text-align: left; padding: 10px; border: 1px solid #ddd;">Customer</th>
                <th style="text-align: left; padding: 10px; border: 1px solid #ddd;">Description</th>
                <th style="text-align: left; padding: 10px; border: 1px solid #ddd;">Status</th>
                <th style="text-align: left; padding: 10px; border: 1px solid #ddd;">Timer</th>
                <th style="text-align: left; padding: 10px; border: 1px solid #ddd;">Rate</th>
                <th style="text-align: left; padding: 10px; border: 1px solid #ddd;">Hours</th>
                <th style="text-align: left; padding: 10px; border: 1px solid #ddd;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for job in jobs %}
            <tr id="job-{{ job.id }}" {% if job.active_timer_id %}class="active-timer"{% endif %}>
                <td style="padding: 10px; border: 1px solid #ddd;">{{ job.customer_name }}</td>
                <td style="padding: 10px; border: 1px solid #ddd;">{{ job.description }}</td>
                <td style="padding: 10px; border: 1px solid #ddd;">
                    <span style="
                        padding: 3px 8px;
                        border-radius: 3px;
                        {% if job.status == 'Active' %}
                            background-color: #4CAF50;
                        {% elif job.status == 'Pending' %}
                            background-color: #FFC107;
                        {% else %}
                            background-color: #9E9E9E;
                        {% endif %}
                        color: white;
                    ">{{ job.status }}</span>
                </td>
                <td style="padding: 10px; border: 1px solid #ddd;">
                    {% if job.status == 'Active' %}
                        <div class="timer-container">
                            <span class="timer" id="timer-{{ job.id }}"
                                  data-start="{{ job.timer_start }}"
                                  data-accumulated="{{ job.accumulated_hours }}"
                                  data-paused="false">
                                00:00:00
                            </span>
                            {% if job.active_timer_id %}
                                <button onclick="stopTimer({{ job.id }})" class="stop-btn">Stop</button>
                                <button onclick="pauseTimer({{ job.id }})" class="pause-btn">Pause</button>
                                <button onclick="resumeTimer({{ job.id }})" class="resume-btn" style="display: none;">Resume</button>
                            {% else %}
                                <button onclick="startTimer({{ job.id }})" class="start-btn">Start</button>
                            {% endif %}
                        </div>
                    {% endif %}
                </td>
                <td style="padding: 10px; border: 1px solid #ddd;">{{ "â‚¬%.2f"|format(job.base_rate) if job.base_rate else '-' }}</td>
                <td style="padding: 10px; border: 1px solid #ddd;">
                    {% if job.total_hours %}
                        {{ "%.1f"|format(job.total_hours) }} / {{ "%.1f"|format(job.estimated_hours) if job.estimated_hours else '-' }}
                    {% else %}
                        0 / {{ "%.1f"|format(job.estimated_hours) if job.estimated_hours else '-' }}
                    {% endif %}
                </td>
                <td style="padding: 10px; border: 1px solid #ddd;">
                    <a href="{{ url_for('main.edit_job', id=job.id) }}" 
                       style="display: inline-block; padding: 5px 10px; background: #2196F3; color: white; text-decoration: none; margin-right: 5px;">
                        Edit
                    </a>
                    <form action="{{ url_for('main.delete_job', id=job.id) }}" method="post" style="display: inline;">
                        <button type="submit" onclick="return confirm('Are you sure you want to delete this job?');"
                                style="padding: 5px 10px; background: #f44336; color: white; border: none; cursor: pointer;">
                            Delete
                        </button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
        let timerIntervals = {};

        function updateTimer(timerElement) {
            const startTime = timerElement.dataset.start;
            const accumulated = parseFloat(timerElement.dataset.accumulated) || 0;
            
            // For running or paused jobs, we should have a start time
            if (!startTime) return;
            
            const start = new Date(startTime);
            const isPaused = timerElement.dataset.paused === 'true';
            
            if (isPaused) {
                // Keep showing the accumulated time when paused
                const hours = Math.floor(accumulated);
                const minutes = Math.floor((accumulated * 60) % 60);
                const seconds = Math.floor((accumulated * 3600) % 60);
                timerElement.textContent = 
                    `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                clearInterval(timerIntervals[timerElement.id]);
                return;
            }
            
            function update() {
                const now = new Date();
                const elapsedHours = (now - start) / (1000 * 60 * 60) + accumulated;
                const hours = Math.floor(elapsedHours);
                const minutes = Math.floor((elapsedHours * 60) % 60);
                const seconds = Math.floor((elapsedHours * 3600) % 60);
                
                timerElement.textContent = 
                    `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }
            
            update();
            clearInterval(timerIntervals[timerElement.id]);
            timerIntervals[timerElement.id] = setInterval(update, 1000);
        }

        function startTimer(jobId) {
            fetch(`/job/${jobId}/start_timer`, {
                method: 'POST',
            }).then(response => {
                if (response.ok) {
                    const jobRow = document.getElementById(`job-${jobId}`);
                    const jobName = jobRow.querySelector('td').textContent;
                    updateGlobalControls(jobId, jobName);
                    window.location.reload();
                }
            });
        }

        function stopTimer(jobId) {
            fetch(`/job/${jobId}/stop_timer`, {
                method: 'POST',
            }).then(response => {
                if (response.ok) {
                    updateGlobalControls(null, null);
                    window.location.reload();
                }
            });
        }

        function pauseTimer(jobId) {
            fetch(`/job/${jobId}/pause_timer`, {
                method: 'POST',
            }).then(response => {
                if (response.ok) {
                    const timer = document.getElementById(`timer-${jobId}`);
                    timer.dataset.paused = 'true';
                    timer.classList.add('paused');
                    
                    clearInterval(timerIntervals[`timer-${jobId}`]); // Clear the interval
                    
                    const container = timer.closest('.timer-container');
                    container.querySelector('.pause-btn').style.display = 'none';
                    container.querySelector('.resume-btn').style.display = 'inline';
                }
            });
        }

        function resumeTimer(jobId) {
            fetch(`/job/${jobId}/resume_timer`, {
                method: 'POST',
            }).then(response => {
                if (response.ok) {
                    const timer = document.getElementById(`timer-${jobId}`);
                    timer.dataset.paused = 'false';
                    timer.classList.remove('paused');
                    updateTimer(timer);
                    
                    const container = timer.closest('.timer-container');
                    container.querySelector('.pause-btn').style.display = 'inline';
                    container.querySelector('.resume-btn').style.display = 'none';
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.timer').forEach(timer => {
                updateTimer(timer);
            });

            const activeTimerRow = document.querySelector('.active-timer');
            if (activeTimerRow) {
                const jobId = activeTimerRow.id.replace('job-', '');
                const jobName = activeTimerRow.querySelector('td').textContent;
                updateGlobalControls(jobId, jobName);
            }
        });
    </script>
</div>
{% endblock %}