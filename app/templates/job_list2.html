<!-- app/templates/job_list.html -->
{% extends "base.html" %}

{% block content %}
<style>
    .timer-container button {
        padding: 5px 10px;
        margin: 0 2px;
        border: none;
        cursor: pointer;
        color: white;
        border-radius: 4px;
    }
    .start-btn, .resume-btn { background: #38977b; }
    .stop-btn { background: #f44336; }
    .pause-btn { background: #ff8b07; }
    .timer.paused { color: #666; }
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    tr[data-timer-active="true"] span.status-active {
        animation: pulse 2s infinite;
    }
    tr[data-timer-paused="true"] span.status-active {
        animation: none;
    }
</style>

<div>
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background: #f5f5f5;">
                <th style="text-align: left; padding: 10px; border: 1px solid #ddd;">Customer</th>
                <th style="text-align: left; padding: 10px; border: 1px solid #ddd;">Description</th>
                <th style="text-align: left; padding: 10px; border: 1px solid #ddd;">Status & Controls</th>
                <th style="text-align: left; padding: 10px; border: 1px solid #ddd;">Actions</th>
                <th style="text-align: left; padding: 10px; border: 1px solid #ddd;">Time</th>
            </tr>
        </thead>
        <tbody>
            {% for job in jobs %}
            <tr id="job-{{ job.id }}" {% if job.active_timer_id %}
                    data-timer-active="true"
                    data-timer-paused="false"
                {% endif %}>
                <td style="padding: 10px; border: 1px solid #ddd;">{{ job.customer_name }}</td>
                <td style="padding: 10px; border: 1px solid #ddd;">{{ job.description }}</td>
                <td style="padding: 10px; border: 1px solid #ddd;">
                    <span class="status-active" style="
                        padding: 3px 8px;
                        border-radius: 4px;
                        {% if job.status == 'Active' %}
                            background-color: #4CAF50;
                        {% elif job.status == 'Pending' %}
                            background-color: #FFC107;
                        {% else %}
                            background-color: #9E9E9E;
                        {% endif %}
                        color: white;
                        margin-right: 10px;
                    ">{{ job.status }}</span>
                    <div class="timer-container" style="display: inline-block;">
                        {% if job.active_timer_id %}
                            <button onclick="stopTimer({{ job.id }})" class="stop-btn">Stop</button>
                            <button onclick="pauseTimer({{ job.id }})" class="pause-btn">Pause</button>
                            <button onclick="resumeTimer({{ job.id }})" class="resume-btn" style="display: none;">Resume</button>
                        {% elif job.status == 'Active' %}
                            <button onclick="startTimer({{ job.id }})" class="start-btn">Start</button>
                        {% endif %}
                    </div>
                </td>
                <td style="padding: 10px; border: 1px solid #ddd;">
                    <a href="{{ url_for('main.edit_job', id=job.id) }}" 
                       style="display: inline-block; padding: 5px 10px; border-radius: 4px; background: #2196F3; color: white; text-decoration: none; margin-right: 5px;">
                        Edit
                    </a>
                    <form action="{{ url_for('main.delete_job', id=job.id) }}" method="post" style="display: inline;">
                        <button type="submit" onclick="return confirm('Are you sure you want to delete this job?');"
                                style="padding: 5px 10px; border-radius: 4px; background: #f44336; color: white; border: none; cursor: pointer;">
                            Delete
                        </button>
                    </form>
                </td>
                <td style="padding: 10px; border: 1px solid #ddd;">
                    <span class="timer" id="timer-{{ job.id }}"
                        {% if job.active_timer_id %}
                            data-start="{{ job.timer_start }}"
                            data-paused="false"
                        {% endif %}
                        data-accumulated="{{ job.accumulated_hours }}">
                        {{ "%d:%02d"|format(job.accumulated_hours|int, 
                        ((job.accumulated_hours % 1) * 60)|round|int) }}
                    </span>
                    {% if job.estimated_hours %}
                        <span class="estimated-hours">
                            / {{ "%d:%02d"|format(job.estimated_hours|int, 
                                ((job.estimated_hours % 1) * 60)|round|int) }}
                        </span>
                    {% else %}
                        <span class="estimated-hours">/ -</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
        let timerIntervals = {};

        function formatTime(hours) {
            if (isNaN(hours) || hours === null) hours = 0;
            let wholeHours = Math.floor(hours);
            let minutes = Math.round((hours * 60 % 60) / 5) * 5;
            if (minutes === 60) {
                wholeHours += 1;
                minutes = 0;
            }
            return `${wholeHours}:${String(minutes).padStart(2, '0')}`;
        }

        function updateTimer(timerElement) {
            const startTime = timerElement.dataset.start;
            const accumulated = parseFloat(timerElement.dataset.accumulated) || 0;
            
            if (!startTime) {
                timerElement.textContent = formatTime(accumulated);
                return;
            }
            
            const start = new Date(startTime);
            const isPaused = timerElement.dataset.paused === 'true';
            
            if (isPaused) {
                timerElement.textContent = formatTime(accumulated);
                clearInterval(timerIntervals[timerElement.id]);
                return;
            }
            
            function update() {
                const now = new Date();
                const elapsedHours = (now - start) / (1000 * 60 * 60) + accumulated;
                timerElement.textContent = formatTime(elapsedHours);
                
                const minutes = now.getMinutes();
                if (minutes % 5 === 0 && now.getSeconds() === 0) {
                    const jobId = timerElement.id.replace('timer-', '');
                    updateJobTotal(jobId);
                }
            }
            
            update();
            clearInterval(timerIntervals[timerElement.id]);
            timerIntervals[timerElement.id] = setInterval(update, 1000);
        }

        function updateJobTotal(jobId) {
            fetch(`/job/${jobId}/update_total`, {
                method: 'POST',
            }).then(response => response.json())
            .then(data => {
                if (data.success) {
                    const row = document.getElementById(`job-${jobId}`);
                    const hoursCell = row.querySelector('td:nth-child(5)');
                    const estHours = hoursCell.textContent.split('/')[1].trim();
                    hoursCell.textContent = `${formatTime(data.total_hours)} / ${estHours}`;
                }
            });
        }

        function startTimer(jobId) {
            fetch(`/job/${jobId}/start_timer`, {
                method: 'POST',
            }).then(response => {
                if (response.ok) {
                    window.location.reload();
                }
            });
        }

        function stopTimer(jobId) {
            fetch(`/job/${jobId}/stop_timer`, {
                method: 'POST',
            }).then(response => {
                if (response.ok) {
                    window.location.reload();
                }
            });
        }

        function pauseTimer(jobId) {
            fetch(`/job/${jobId}/pause_timer`, {
                method: 'POST',
            }).then(response => {
                if (response.ok) {
                    const row = document.getElementById(`job-${jobId}`);
                    row.dataset.timerPaused = 'true';
                    row.dataset.timerActive = 'false';
                    
                    const timer = document.getElementById(`timer-${jobId}`);
                    timer.dataset.paused = 'true';
                    
                    const container = row.querySelector('.timer-container');
                    container.querySelector('.pause-btn').style.display = 'none';
                    container.querySelector('.resume-btn').style.display = 'inline';
                }
            });
        }

        function resumeTimer(jobId) {
            fetch(`/job/${jobId}/resume_timer`, {
                method: 'POST',
            }).then(response => {
                if (response.ok) {
                    const row = document.getElementById(`job-${jobId}`);
                    row.dataset.timerPaused = 'false';
                    row.dataset.timerActive = 'true';
                    
                    const timer = document.getElementById(`timer-${jobId}`);
                    timer.dataset.paused = 'false';
                    
                    const container = row.querySelector('.timer-container');
                    container.querySelector('.pause-btn').style.display = 'inline';
                    container.querySelector('.resume-btn').style.display = 'none';
                    
                    updateTimer(timer);
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.timer').forEach(timer => {
                updateTimer(timer);
            });

            document.querySelectorAll('.active-timer').forEach(row => {
                const timer = row.querySelector('.timer');
                if (timer) {
                    updateTimer(timer);
                }
            });
        });
    </script>
</div>
{% endblock %}